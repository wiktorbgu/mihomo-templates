- [Шаблоны настроек для Docker-образа Mihomo на MikroTik](#шаблоны-настроек-для-docker-образа-mihomo-на-mikrotik)
- [Как использовать шаблоны](#как-использовать-шаблоны)
- [Как выбрать шаблон](#как-выбрать-шаблон)
- [Переключатели: что это и зачем](#переключатели-что-это-и-зачем)
  - [Важно!](#важно)
- [Шаблон «Облегчённый» (для новичков)](#шаблон-облегчённый-для-новичков)
- [Шаблон «Большой» (для продвинутых)](#шаблон-большой-для-продвинутых)
- [Новое! Шаблон с автоматическими цепочками (для экспериментаторов)](#новое-шаблон-с-автоматическими-цепочками-для-экспериментаторов)
- [Важные замечания](#важные-замечания)

## Шаблоны настроек для Docker-образа Mihomo на MikroTik

Этот файл рассказывает, как использовать готовые шаблоны настроек для контейнера Mihomo на роутере MikroTik https://hub.docker.com/r/wiktorbgu/mihomo-mikrotik

## Как использовать шаблоны

Готовые шаблоны обычно копируют по SFTP в папку на роутере:
`/usb1/docker_configs/mihomo_mikrotik/template`

Если вы подключаете публичные подписки по ссылкам (через переменные `SUB1`, `SUB2` и т.д.), рекомендуется использовать [специальный фильтр подписок](https://github.com/Viktor45/sub-filter). Этот фильтр уберёт всё лишнее из подписки: кривые серверы, небезопасные настройки и "мусор", из-за которого Mihomo может ругаться. Но если твои подписки и так чистые — фильтр не обязателен.

## Как выбрать шаблон

Чтобы указать, какой шаблон использовать, нужно задать переменную окружения `CONFIG` в контейнере. В каждом шаблоне есть комментарии — читайте их, чтобы понять, чем он отличается.

## Переключатели: что это и зачем

В шаблонах есть переключатели — они помогают выбирать, через какой прокси идёт трафик. Вот краткое описание:

| Название переключателя | Тип          | Автоматический? | Описание                                          |
| ---------------------- | ------------ | --------------- | ------------------------------------------------- |
| SELECTOR               | **Selector** | НЕТ             | Главный переключатель — выбирайте его вручную     |
| MANUAL                 | **Selector** | НЕТ             | Ручной выбор прокси, когда автоматика не нужна    |
| AUTO                   | Fallback     | ДА              | Автоматический иностранный прокси                 |
| FASTEST                | URLTest      | ДА              | Самый быстрый иностранный прокси                  |
| FAILOVER               | Fallback     | ДА              | Надёжный иностранный прокси                       |
| RU_AUTO                | Fallback     | ДА              | Автоматический российский прокси                  |
| RU_FASTEST             | URLTest      | ДА              | Самый быстрый российский прокси                   |
| RU_FAILOVER            | Fallback     | ДА              | Надёжный российский прокси                        |
| VIA_RU_AUTO            | Fallback     | ДА              | В заграницу через российский прокси (авто)        |
| VIA_RU_FASTEST         | URLTest      | ДА              | В заграницу через самый быстрый российский прокси |
| VIA_RU_FAILOVER        | Fallback     | ДА              | В заграницу через надёжный российский прокси      |

### Важно!

При первом запуске обязательно дождитесь прогрузки подписок и настройте `SELECTOR` и `MANUAL` вручную — выберите нужные прокси.

Не трогайте переключатели с типами `Fallback` и `URLTest` — они работают автоматически. Если случайно их поменять, автоматика сломается.

Как починить?
— Нажмите правой кнопкой мыши на название сбитого переключателя — логика автоматически восстановится.

## Шаблон «Облегчённый» (для новичков)

Файл: `stargate-lite.yaml`

Этот шаблон — самый простой и быстрый. Идеально подходит для домашнего использования.
- Потребляет около 20 МБ оперативной памяти.
- Меньше переключателей — меньше путаницы.

Как использовать:
Добавьте в настройки контейнера:
`CONFIG="stargate-lite.yaml"`

Команда для MikroTik:
`/container envs add list=MIHOMO key=CONFIG value="stargate-lite.yaml"`

## Шаблон «Большой» (для продвинутых)

Файл: `stargate.yaml`

Этот шаблон включает всё: все функции, все переключатели и настройки.
Но:
- Много переключателей — можно запутаться.
- Занимает около 40 МБ (или даже больше, если включить всё).

Как использовать:
`CONFIG="stargate.yaml"`

Команда для MikroTik:
`/container envs add list=MIHOMO key=CONFIG value="stargate.yaml"`

## Новое! Шаблон с автоматическими цепочками (для экспериментаторов)

Файл: `stargate-chain.yaml`

Этот шаблон создаёт цепочки прокси: сначала трафик идёт на российский сервер, а потом — в любую другую страну. Очень полезно, если вы хотите улучшить связанность своего трафика, например при белых списках. Но помните, при цепочках увеличивается пинг, т.к. используются ДВА ПРОКСИ.

Важно:
- Убедитесь, что у вас в подписках есть хотя бы несколько рабочих российских прокси.
- Если сомневаетесь — добавьте несколько разных подписок через `SUB1`, `SUB2` и т.д.

Особенности:
- Работает **только** с подписками (`SUB`).
- Прокси типа AWG и WARP автоматически исключаются — они не поддерживают цепочки.
- Расход памяти изза наложения подписок для сцепления может быть больше на 30-50% от того, сколько занял бы облегченный шаблон.
  
Необходимо вручную положить два файла на роутер по следующим путям:
  - [stargate-chain.yaml](chain/stargate-chain.yaml) → в папку в шаблонами `/usb1/docker_configs/mihomo_mikrotik/template`
  - перезаписать [entrypoint.sh](chain/entrypoint.sh) → в папке с контейнером `/usb1/docker/mihomo_mikrotik/`. Если этого не сделать расширенные фунции по генерации цепочек не будут работать. Изучите файл, если сомневаетесь - используйте облегченный шаблон.

Не забудьте:
- Сделайте `entrypoint.sh` исполняемым до копирования: `chmod +x entrypoint.sh`
- Копируйте файлы, когда контейнер остановлен.

Как использовать:
`CONFIG="stargate-chain.yaml"`

Команда для MikroTik:
`/container envs add list=MIHOMO key=CONFIG value="stargate-chain.yaml"`

## Важные замечания

- Все шаблоны содержат комментарии — читайте их, если что-то непонятно.
- Сохраняйте файлы в UTF-8 без [BOM](https://en.wikipedia.org/wiki/Byte_order_mark) (это специальная метка в начале файла). Иначе Mihomo может не понять настройки. Как проверить? Откройте файл в редакторе, который умеет показывать BOM (например, VS Code), и убедитесь, что стоит кодировка UTF-8 без BOM.

Больше информации:
https://hub.docker.com/r/wiktorbgu/mihomo-mikrotik