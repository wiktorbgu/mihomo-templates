--- ./original/entrypoint.sh	2025-11-24 23:34:25.000000000 +0300
+++ ./entrypoint.sh	2025-12-24 23:50:02.353834628 +0300
@@ -39,6 +39,10 @@
   fi
 fi
 
+# Эта ссылка используется для проверки, работает ли интернет.
+# Если ответ приходит — значит, интернет есть.
+HEALTH_CHECK_URL="${HEALTH_CHECK_URL:-https://www.gstatic.com/generate_204  }"
+
 DEFAULT_CONFIG=$(cat << 'EOF'
 external-controller: $EXTERNAL_CONTROLLER_ADDRESS:$UI_PORT
 external-ui: $EXTERNAL_UI_PATH
@@ -56,6 +60,7 @@
 
 proxy-providers:
 $PROVIDERS_BLOCK
+$PROVIDERS_CHAIN_BLOCK
 
 proxy-groups:
   - name: SELECTOR
@@ -175,19 +180,15 @@
 
   echo "  - name: \"$awg_name\""
   echo "    type: wireguard"
-
   [ -n "$private_key" ] && echo "    private-key: $private_key"
   [ -n "$server" ] && echo "    server: $server"
   [ -n "$port" ] && echo "    port: $port"
   [ -n "$address" ] && echo "    ip: $address"
   [ -n "$mtu" ] && echo "    mtu: $mtu"
   [ -n "$public_key" ] && echo "    public-key: $public_key"
-
   echo "    allowed-ips: ['0.0.0.0/0']"
   [ -n "$psk" ] && echo "    pre-shared-key: $psk"
-
   echo "    udp: true"
-
   [ -n "$dns" ] && echo "    dns: [ $dns ]"
   echo "    remote-dns-resolve: true"
   awg_params="jc jmin jmax s1 s2 h1 h2 h3 h4 i1 i2 i3 i4 i5 j1 j2 j3 itime"
@@ -211,7 +212,6 @@
 add_provider_block() {
     local name="$1"
     local path="$2"
-
     PROVIDERS_BLOCK="${PROVIDERS_BLOCK}  ${name}:
     type: file
     path: ${path}
@@ -227,8 +227,47 @@
 "
 }
 
+# Функция для добавления подписки по HTTP (SUB1, SUB2 и т.д.)
+add_http_provider() {
+    local name="$1"
+    local url="$2"
+    PROVIDERS_BLOCK="${PROVIDERS_BLOCK}  ${name}:
+    type: http
+    url: \"${url}\"
+    interval: 86400        # Обновлять раз в сутки
+    health-check:
+      enable: true
+      url: \"${HEALTH_CHECK_URL}\"
+      interval: 86400      # Проверка состояния — тоже раз в сутки
+"
+    PROVIDERS_LIST="${PROVIDERS_LIST}      - ${name}
+"
+}
+
+# Функция для создания "цепочек": иностранные серверы → через российский прокси
+# Эти провайдеры автоматически перенаправляют трафик через RU_AUTO
+add_http_chain_provider() {
+    local name="$1"
+    local url="$2"
+    local chain_name="${name}-via-ru"
+    PROVIDERS_CHAIN_BLOCK="${PROVIDERS_CHAIN_BLOCK}  ${chain_name}:
+    type: http
+    url: \"${url}\"
+    interval: 86400
+    override:
+      dialer-proxy: RU_AUTO            # Сначала идём через RU_AUTO
+      exclude-filter: \"(?i)awg|warp\" # Исключаем AWG/WARP — они не поддерживают цепочки
+"
+    PROVIDERS_CHAIN_LIST="${PROVIDERS_CHAIN_LIST}      - ${chain_name}
+"
+}
+
+# Обнуляем переменные, которые будут заполнены дальше
 PROVIDERS_BLOCK=""
 PROVIDERS_LIST=""
+PROVIDERS_CHAIN_BLOCK=""
+PROVIDERS_CHAIN_LIST=""
+
 ####
 srv_file="$WORKDIR/srv.yaml"
 if env | grep -qE '^(SRV)[0-9]'; then
@@ -263,25 +302,22 @@
 while IFS='=' read -r name value; do
   case "$name" in
     SUB[0-9]*)
-      PROVIDERS_BLOCK="${PROVIDERS_BLOCK}  ${name}:
-    url: \"${value}\"
-    type: http
-    interval: 86400
-    health-check:
-      enable: true
-      url: \"${HEALTH_CHECK_URL}\"
-      interval: 86400
-"
-    PROVIDERS_LIST="${PROVIDERS_LIST}      - $(echo "$name")
-"
+      # Экранируем кавычки в URL, чтобы YAML не сломался
+      value_clean=$(printf '%s' "$value" | sed 's/"/\\"/g')
+      # Добавляем обычный провайдер
+      add_http_provider "$name" "$value_clean"
+      # Добавляем цепочку для этого же источника
+      add_http_chain_provider "$name" "$value_clean"
       ;;
   esac
-done <<EOF
+done << EOF
 $(env)
 EOF
 
 export PROVIDERS_BLOCK
 export PROVIDERS_LIST
+export PROVIDERS_CHAIN_BLOCK
+export PROVIDERS_CHAIN_LIST
 
 envsubst < "$TEMPLATE_DIR/$CONFIG" > "$WORKDIR/$CONFIG"
 
